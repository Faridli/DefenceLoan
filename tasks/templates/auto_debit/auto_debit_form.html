{% extends "user.html" %}

{% block left %}
    {% include "loans/user_board.html" %}
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto p-6 shadow-md rounded-md bg-white">

    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-3 rounded text-white {% if message.tags %}bg-{{ message.tags }}-500{% else %}bg-green-500{% endif %} shadow">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <h2 class="text-xl font-semibold mb-4">Auto-Debit Setup</h2>

    {% if loan and loan.id %}
        <div class="mb-4 p-4 bg-gray-50 border border-gray-200 rounded">
            <p><strong>Monthly Installment:</strong> {{ loan.monthly_installment }} BDT</p>
            <p><strong>Remaining Duration:</strong> {{ loan.duration_months|add:"-loan.months_paid" }} months</p>
        </div>

        <!-- Auto-Debit Form -->
        <form method="post" action="{% url 'auto_debit_callback' %}">
            {% csrf_token %}

            <!-- Hidden inputs required for callback -->
            <input type="hidden" name="loan_id" value="{{ loan.id }}">
            <input type="hidden" name="subscription_id" value="{{ subscription_id|default:'' }}">
            <input type="hidden" name="card_token" value="{{ card_token|default:'' }}">
            <input type="hidden" name="status" value="{{ status|default:'PENDING' }}">

            <div class="mb-3">
                <label class="block font-medium mb-1">Start Date</label>
                <input type="date" name="start_date" required class="w-full border rounded p-2" value="{{ today }}">
            </div>

            <div class="mb-3">
                <label class="block font-medium mb-1">মাসিক কিস্তি (৳)</label>
                <input type="number" name="amount" required class="w-full border rounded p-2" step="0.01" value="{{ loan.monthly_installment }}">
            </div>

            <div class="mb-4">
                <label class="block font-medium mb-1">মেয়াদ (মাস)</label>
                <input type="number" name="months" required class="w-full border rounded p-2" min="1" value="{{ loan.duration_months|add:"-loan.months_paid" }}">
            </div>

            <div class="mb-4">
                <label class="flex flex-col bg-gray-50 p-4 rounded-md border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <span class="inline-flex items-center">
                        <input type="checkbox" name="agree" required class="mr-3 h-5 w-5 text-blue-600 rounded">
                        <span class="font-medium text-gray-800">আমি Auto-Debit-এর জন্য সম্মতি দিচ্ছি</span>
                    </span>
                    <span class="mt-2 text-sm text-gray-600">
                        আমি নিশ্চিত করছি যে, আমার ব্যাংক হিসাব থেকে প্রয়োজনীয় পরিমাণ অর্থ স্বয়ংক্রিয়ভাবে কর্তন করা হবে এবং আমি এ লেনদেনে সম্পূর্ণ অনুমোদিত।
                    </span>
                </label>
            </div>

            <button type="submit" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                Submit
            </button>
        </form>
    {% else %}
        <p class="text-gray-500">No loan selected or Auto-Debit cannot be setup.</p>
    {% endif %}
</div>
{% endblock %}




{% comment %} 

<form method="post" action="{% url 'auto_debit_callback' loan.id %}">
    {% csrf_token %}
    <input type="hidden" name="subscription_id" value="{{ subscription_id }}">
    <input type="hidden" name="card_token" value="{{ card_token }}">
    <input type="hidden" name="status" value="{{ status }}">
    
    <button type="submit">Submit</button>
</form> {% endcomment %}
